<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd"
  objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
  <changeSet id="Feature_14105_Implement_new_workflow_entities" author="elkayssin">
  
  	<sql>CREATE TYPE step_resource_type AS ENUM (
    	'input',
    	'output',
    	'support')
    </sql>
    
    <sql>CREATE TYPE step_resource_value AS ENUM (
    	'specimen',
    	'specimen_replicate',
    	'mixed_specimen',
    	'sample',
    	'pcr_batch',
    	'seq_batch',
    	'seq_submission',
    	'kit',
    	'region',
    	'primer',
    	'thermocycler_profile',
    	'protocol')
    </sql>
    
    <createTable tableName="ChainTemplates">
    	<column name="ChainTemplateID" type="integer" autoIncrement="true">
    		<constraints primaryKey="true"/>
    	</column>
    	<column name="Name" type="varchar(50)">
    		<constraints nullable="false"/>
    	</column>
    </createTable>
    
    <createTable tableName="StepTemplates">
    	<column name="StepTemplateID" type="integer" autoIncrement="true">
    		<constraints primaryKey="true"/>
    	</column>
    	<column name="Name" type="varchar(50)">
    		<constraints nullable="false"/>
    	</column>
    	<column name="Inputs" type="step_resource_value []">
    		<constraints nullable="false"/>
    	</column>
    	<column name="Outputs" type="step_resource_value []">
    		<constraints nullable="false"/>
    	</column>
    	<column name="Supports" type="step_resource_value []"/>
    </createTable>
    
    <createTable tableName="ChainStepTemplates">
    	<column name="ChainTemplateID" type="integer">
    		<constraints foreignKeyName="fk_chain_template_id" references="ChainTemplates(ChainTemplateID)"/>
    	</column>
    	<column name="StepTemplateID" type="integer">
    		<constraints foreignKeyName="fk_step_template_id" references="StepTemplates(StepTemplateID)"/>
    	</column>
    	<column name="StepNumber" type="integer">
    		<constraints nullable="false"/>
    	</column>
    </createTable>
    
    <addPrimaryKey tableName="ChainStepTemplates" columnNames="ChainTemplateID, StepTemplateID"/>
    
    <createTable tableName="Chains">
    	<column name="ChainID" type="integer" autoIncrement="true">
    		<constraints primaryKey="true"/>
    	</column>
    	<column name="Name" type="varchar(50)">
    		<constraints nullable="false"/>
    	</column>
    	<column name="DateCreated" type="datetime">
    		<constraints nullable="false"/>
    	</column>
    	<column name="ChainTemplateID" type="integer">
    		<constraints foreignKeyName="fk_chain_template_id" references="ChainTemplates(ChainTemplateID)" nullable="false"/>
    	</column>
    	<column name="GroupID" type="integer">
    		<constraints foreignKeyName="fk_group_id" references="Groups(GroupID)" nullable="false"/>
    	</column>
    </createTable>
    
    <addUniqueConstraint columnNames="ChainID,ChainTemplateID" tableName="Chains"/>
    
    <createTable tableName="StepResources">
    	<column name="StepResourceID" type="integer" autoIncrement="true">
    		<constraints primaryKey="true"/>
    	</column>
    	<column name="Type" type="step_resource_type">
    		<constraints nullable="false"/>
    	</column>
    	<column name="Value" type="step_resource_value">
    		<constraints nullable="false"/>
    	</column>
    	<column name="ChainID" type="integer">
    		<constraints nullable="false"/>
    	</column>
    	<column name="ChainTemplateID" type="integer">
    		<constraints nullable="false"/>
    	</column>
    	<column name="StepTemplateID" type="integer">
    		<constraints nullable="false"/>
    	</column>
    	<column name="SpecimenID" type="integer">
    		<constraints foreignKeyName="fk_specimen_id" references="Specimens(SpecimenID)"/>
    	</column>
    	<column name="SpecimenReplicateID" type="integer">
    		<constraints foreignKeyName="fk_specimen_replicate_id" references="SpecimenReplicates(SpecimenReplicateID)"/>
    	</column>
    	<column name="MixedSpecimenID" type="integer">
    		<constraints foreignKeyName="fk_mixed_specimen_id" references="MixedSpecimens(MixedSpecimenID)"/>
    	</column>
    	<column name="SampleID" type="integer">
    		<constraints foreignKeyName="fk_sample_id" references="Samples(SampleID)"/>
    	</column>
    	<column name="PcrBatchID" type="integer">
    		<constraints foreignKeyName="fk_pcr_batch_id" references="PcrBatchs(PcrBatchID)"/>
    	</column>
    	<column name="SeqBatchID" type="integer">
    		<constraints foreignKeyName="fk_seq_batch_id" references="SeqBatchs(SeqBatchID)"/>
    	</column>
    	<column name="SeqSubmissionID" type="integer">
    		<constraints foreignKeyName="fk_seq_submission_id" references="SeqSubmissions(SeqSubmissionID)"/>
    	</column>
    	<column name="ProductID" type="integer">
    		<constraints foreignKeyName="fk_product_id" references="Products(ProductID)"/>
    	</column>
    	<column name="RegionID" type="integer">
    		<constraints foreignKeyName="fk_region_id" references="Regions(TagID)"/>
    	</column>
    	<column name="PrimerID" type="integer">
    		<constraints foreignKeyName="fk_primer_id" references="PcrPrimers(PcrPrimerID)"/>
    	</column>
    	<column name="PcrProfileID" type="integer">
    		<constraints foreignKeyName="fk_pcr_profile_id" references="PcrProfiles(PcrProfileID)"/>
    	</column>
    	<column name="ProtocolID" type="integer">
    		<constraints foreignKeyName="fk_protocol_id" references="Protocols(ProtocolID)"/>
    	</column>
    </createTable>
    
    <addForeignKeyConstraint constraintName="fk_chain_step_template_id" 
    	baseTableName="StepResources" 
    	baseColumnNames="ChainTemplateID,StepTemplateID" 
    	referencedTableName="ChainStepTemplates" 
    	referencedColumnNames="ChainTemplateID,StepTemplateID"/>
    	
    <addForeignKeyConstraint constraintName="fk_chain_id" 
    	baseTableName="StepResources" 
    	baseColumnNames="ChainID,ChainTemplateID" 
    	referencedTableName="Chains" 
    	referencedColumnNames="ChainID,ChainTemplateID"/>
  </changeSet>
</databaseChangeLog>